<!DOCTYPE html>
<html lang="pt-BR">

<head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro Passageiro - Passo 1</title>
    <link rel="stylesheet" href="style.css">

    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
    
</head>

<body>

    <div class="container">

        <section class="login-box">

            <div class="btn-voltar">
                <a href="index.html" class="ri-arrow-left-line"></a>
            </div>

            <div class="box-titulo">
                <h1 class="titulo">Informações de cadastro</h1>
            </div>

            <form class="upload-container form-login">

                <h2>Dados do passageiro</h2>

                <label>Nome</label>
                <input type="text" id="Nome" required>

                <label>Sobrenome</label>
                <input type="text" id="Sobrenome" required>

                <label>E-mail</label>
                <input type="email" id="email" required>

                <div class="input-group">
                    <label>Senha</label>
                    <input type="password" id="senha1" required>
                    <i id="toggleSenha1" class="ri-eye-close-line"></i>
                </div>

                <div class="input-group">
                    <label>Repita sua senha</label>
                    <input type="password" id="senha2" required>
                    <i id="toggleSenha2" class="ri-eye-close-line"></i>
                </div>

                <label>Data de Nascimento</label>
                <input type="date" id="dataNascimento" required style="color: #666;">

                <label>CPF</label>
                <input type="text" id="cpf" placeholder="000.000.000-00" maxlength="14">

                <label>Telefone</label>
                <input type="text" id="telefone" placeholder="(00) 00000-0000" maxlength="15">

            </form>

            <div class="upload-container box">
                <h2>Foto de perfil</h2>
                <img src="images/adicionar-imagem.svg" id="preview-fotoPerfil" class="upload-img">
                <input type="file" id="file-fotoPerfil" accept="image/*" hidden>
                <label for="file-fotoPerfil" class="btn upload">Selecionar imagem</label>
            </div>

            <div class="upload-container box">
                <h2>Comprovante de Matrícula</h2>
                <img src="images/adicionar-imagem.svg" id="preview-matricula" class="upload-img">
                <input type="file" id="file-matricula" accept="image/*" hidden>
                <label for="file-matricula" class="btn upload">Enviar comprovante</label>
            </div>

            <button class="btn" id="btnCadastrarPassageiro">Próximo passo</button>

        </section>

    </div>

    <div id="modalCrop" class="modal-crop">
        <h3 style="color:white; margin-bottom: 10px;">Ajuste sua foto</h3>
        <div class="crop-container">
            <img id="imageToCrop" src="">
        </div>
        <div class="crop-controls">
            <button id="btnCancelarCrop" class="btn-crop btn-cancelar">Cancelar</button>
            <button id="btnConfirmarCrop" class="btn-crop btn-confirmar">Cortar e Salvar</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>


    <script>
        
        const cpfInput = document.getElementById('cpf');
        cpfInput.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, "");
            
            if (value.length > 11) value = value.slice(0, 11);

            
            value = value.replace(/(\d{3})(\d)/, "$1.$2");
            value = value.replace(/(\d{3})(\d)/, "$1.$2");
            value = value.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
            
            e.target.value = value;
        });

        // Máscara Telefone
        const phoneInput = document.getElementById('telefone');
        phoneInput.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, "");
            
            if (value.length > 11) value = value.slice(0, 11);

            
            if (value.length > 2) {
                value = value.replace(/^(\d{2})(\d)/, "($1) $2");
            }
            if (value.length > 9) { 
                value = value.replace(/(\d{5})(\d{4})$/, "$1-$2"); 
            }
            
            e.target.value = value;
        });

        // PREVIEW MATRÍCULA 
        const matriculaInput = document.getElementById("file-matricula");
        const matriculaPreview = document.getElementById("preview-matricula");
        matriculaInput.addEventListener("change", () => {
            const file = matriculaInput.files[0];
            if (file) matriculaPreview.src = URL.createObjectURL(file);
        });

        // TOGGLE SENHA 
        const togglePassword = (inputId, iconId) => {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(iconId);
            icon.onclick = () => {
                input.type = input.type === "password" ? "text" : "password";
                icon.classList.toggle("ri-eye-line");
                icon.classList.toggle("ri-eye-close-line");
            };
        };
        togglePassword("senha1", "toggleSenha1");
        togglePassword("senha2", "toggleSenha2");
    </script>

   
    <script type="module">
        import { db, auth } from "./js/firebase.js"; 
        import { createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { doc, setDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        // Variável global para armazenar a foto recortada
        let blobFotoPerfilFinal = null;
        let cropper = null;

        // Elementos do Crop
        const modalCrop = document.getElementById("modalCrop");
        const imageToCrop = document.getElementById("imageToCrop");
        const inputFoto = document.getElementById("file-fotoPerfil");
        const previewFoto = document.getElementById("preview-fotoPerfil");

        // Selecionar foto e abrir Crop
        inputFoto.addEventListener("change", (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    imageToCrop.src = evt.target.result;
                    modalCrop.style.display = "flex";

                    if (cropper) cropper.destroy();

                    cropper = new Cropper(imageToCrop, {
                        aspectRatio: 1, 
                        viewMode: 1,
                        autoCropArea: 0.8,
                    });
                };
                reader.readAsDataURL(file);
            }
        });

        // Cancelar Crop
        document.getElementById("btnCancelarCrop").onclick = () => {
            modalCrop.style.display = "none";
            inputFoto.value = "";
            if (cropper) cropper.destroy();
        };

        // Confirmar Crop
        document.getElementById("btnConfirmarCrop").onclick = () => {
            if (!cropper) return;

            cropper.getCroppedCanvas({ width: 400, height: 400 }).toBlob((blob) => {
                blobFotoPerfilFinal = blob;
                previewFoto.src = URL.createObjectURL(blob);
                modalCrop.style.display = "none";
                cropper.destroy();
            }, 'image/jpeg', 0.9);
        };

        // CONFIGURAÇÃO CLOUDINARY
        const CLOUD_NAME = "des5d3k1x";
        const UPLOAD_PRESET = "UniRide";

        async function uploadToCloudinary(fileOrBlob) {
            if (!fileOrBlob) return "";
            const formData = new FormData();
            formData.append("file", fileOrBlob);
            formData.append("upload_preset", UPLOAD_PRESET);
            formData.append("folder", "usuarios");

            try {
                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
                    method: "POST", body: formData
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || "Erro no upload");
                }
                const data = await response.json();
                return data.secure_url;
            } catch (error) {
                console.error("Erro detalhado:", error);
                throw error;
            }
        }

        // CADASTRO
        async function cadastrarPassageiro() {
            const nome = document.getElementById("Nome").value.trim();
            const sobrenome = document.getElementById("Sobrenome").value.trim();
            const email = document.getElementById("email").value.trim();
            const senha1 = document.getElementById("senha1").value;
            const senha2 = document.getElementById("senha2").value;
            const cpf = document.getElementById("cpf").value.trim();
            const telefone = document.getElementById("telefone").value.trim();
            
            // Tratamento da Data
            let dataRaw = document.getElementById("dataNascimento").value;
            let dataFormatada = "";
            if (dataRaw) {
                const partes = dataRaw.split("-");
                if (partes.length === 3) {
                    dataFormatada = `${partes[2]}/${partes[1]}/${partes[0]}`;
                }
            }

            if (senha1 !== senha2) return alert("As senhas não coincidem!");
            if (!nome || !sobrenome || !email || !cpf || !telefone || !dataFormatada) {
                return alert("Por favor, preencha todos os campos.");
            }

            const btn = document.getElementById("btnCadastrarPassageiro");

            try {
                btn.innerText = "Processando...";
                btn.disabled = true;

                const cred = await createUserWithEmailAndPassword(auth, email, senha1);
                const uid = cred.user.uid;

                let fotoURL = "";
                let matURL = "";

                if (blobFotoPerfilFinal) {
                    btn.innerText = "Enviando foto de perfil...";
                    fotoURL = await uploadToCloudinary(blobFotoPerfilFinal);
                }

                const matriculaFile = document.getElementById("file-matricula").files[0];
                if (matriculaFile) {
                    btn.innerText = "Enviando matrícula...";
                    matURL = await uploadToCloudinary(matriculaFile);
                }

                btn.innerText = "Finalizando...";
                await setDoc(doc(db, "passageiros", uid), {
                    nome, sobrenome, email, cpf, telefone, 
                    dataNascimento: dataFormatada, // Salva formatada BR
                    fotoPerfilURL: fotoURL,
                    comprovanteMatriculaURL: matURL,
                    sobreVoce: "", preferencias: [],
                    createdAt: new Date().toISOString()
                });

                window.location.href = "telaCadastroPassageiro2.html";

            } catch (err) {
                console.error(err);
                btn.innerText = "Próximo passo";
                btn.disabled = false;
                
                if (err.code === "auth/email-already-in-use") alert("E-mail já em uso.");
                else if (err.code === "auth/weak-password") alert("Senha fraca.");
                else alert("Erro: " + err.message);
            }
        }

        document.getElementById("btnCadastrarPassageiro").addEventListener("click", (e) => {
            e.preventDefault();
            cadastrarPassageiro();
        });
    </script>

</body>
</html>