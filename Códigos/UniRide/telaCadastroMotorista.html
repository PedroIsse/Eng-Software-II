<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documentação do Motorista</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
</head>

<body>
    <div class="container">

        <section class="Cadastro-CNH">

            <div class="btn-voltar">
                <a href="telaCadastroPassageiro2.html" class="ri-arrow-left-line"></a>
            </div>

            <div class="box-titulo">
                <h1 class="titulo">Documentação do Motorista</h2>
            </div>

            <div class="upload-container box">
                <h2>CNH com EAR (Exerce atividade Remunerada)</h2>
                <img src="images/adicionar-imagem.svg" class="upload-img" id="preview-cnh" height="80px">
                <form>
                    <input type="file" id="file-cnh" accept="image/*" hidden>
                    <label for="file-cnh" class="btn upload">Enviar imagem</label>
                </form>
            </div>

            <div class="upload-container box">
                <h2>Documento do Veículo</h2>
                <img src="images/adicionar-imagem.svg" class="upload-img" id="preview-docCarro" height="80px">
                <form>
                    <input type="file" id="file-docCarro" accept="image/*" hidden>
                    <label for="file-docCarro" class="btn upload">Enviar comprovante</label>
                </form>
            </div>
            <div class="upload-container box">
                <h2>Seguro do Veículo</h2>
                <img src="images/adicionar-imagem.svg" class="upload-img" id="preview-seguro" height="80px">
                <form>
                    <input type="file" id="file-seguro" accept="image/*" hidden>
                    <label for="file-seguro" class="btn upload">Enviar comprovante</label>
                </form>
            </div>

            <div class="upload-container box">
                <h2>Selfie com CNH:</h2>
                <img src="images/adicionar-imagem.svg" class="upload-img" id="preview-selfie" height="80px">
                <form>
                    <input type="file" id="file-selfie" accept="image/*" hidden>
                    <label for="file-selfie" class="btn upload">Enviar comprovante</label>
                </form>
            </div>

            <div class="btn-group">
                <a id="openPopupPular" class="btns upload">Finalizar</a>
            </div>

            <div id="popupPular" class="popup">
                <div class="popup-content">
                    <h2>Cadastro finalizado.</h2>
                    <h3>Você será redirecionado a tela de login.</h3>
                    <br>

                    <div class="btn-group">
                        <a href="telaLogin.html" id="closePopupPular" class="btns upload">Ok</a>

                    </div>
                </div>
            </div>
    </div>
    </section>
    <script>
        function configurarPreview(inputId, imgId) {
            const input = document.getElementById(inputId);
            const img = document.getElementById(imgId);


            input.addEventListener("change", () => {
                const arquivo = input.files[0];
                if (arquivo) {
                    img.src = URL.createObjectURL(arquivo);
                }
            });
        }
        configurarPreview("file-cnh", "preview-cnh");
        configurarPreview("file-docCarro", "preview-docCarro");
        configurarPreview("file-seguro", "preview-seguro");
        configurarPreview("file-selfie", "preview-selfie");

        document.getElementById("openPopupPular").onclick = function (e) {
            e.preventDefault();
            document.getElementById("popupPular").style.display = "flex";
        }

        document.getElementById("closePopupPular").onclick = function () {
            document.getElementById("popupPular").style.display = "none";
        }

    </script>

<script type="module">

import { db, auth, storage } from "./js/firebase.js";
import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";
import { doc, setDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

async function salvarArquivo(refe, arquivo) {
    await uploadBytes(refe, arquivo);
    return await getDownloadURL(refe);
}

async function finalizarCadastroMotorista() {
    const uid = auth.currentUser?.uid;
    if (!uid) {
        alert("Usuário não autenticado.");
        return;
    }

    const cnhFile = document.getElementById("file-cnh").files[0];
    const docCarroFile = document.getElementById("file-docCarro").files[0];
    const seguroFile = document.getElementById("file-seguro").files[0];
    const selfieFile = document.getElementById("file-selfie").files[0];

    try {
        const cnhURL = cnhFile ? await salvarArquivo(ref(storage, `motoristas/${uid}/cnh.jpg`), cnhFile) : "";
        const docCarroURL = docCarroFile ? await salvarArquivo(ref(storage, `motoristas/${uid}/docCarro.jpg`), docCarroFile) : "";
        const seguroURL = seguroFile ? await salvarArquivo(ref(storage, `motoristas/${uid}/seguro.jpg`), seguroFile) : "";
        const selfieURL = selfieFile ? await salvarArquivo(ref(storage, `motoristas/${uid}/selfie.jpg`), selfieFile) : "";

        await setDoc(doc(db, "motoristas", uid), {
            cnhURL, docCarroURL, seguroURL, selfieURL,
            updatedAt: new Date().toISOString()
        });

        // show existing popup
        document.getElementById("popupPular")?.style.display = "flex";
    } catch (err) {
        console.error(err);
        alert("Erro ao enviar documentos: " + (err.message || err));
    }
}

document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("openPopupPular");
    if (btn) btn.addEventListener("click", (e) => { e.preventDefault(); finalizarCadastroMotorista(); });
    // preview handlers
    const setupPreview = (inputId, imgId) => {
        const input = document.getElementById(inputId);
        const img = document.getElementById(imgId);
        if (!input || !img) return;
        input.addEventListener("change", () => {
            const arquivo = input.files[0];
            if (arquivo) {
                img.src = URL.createObjectURL(arquivo);
            } else {
                img.src = "images/adicionar-imagem.svg";
            }
        });
    };
    setupPreview("file-cnh","preview-cnh");
    setupPreview("file-docCarro","preview-docCarro");
    setupPreview("file-seguro","preview-seguro");
    setupPreview("file-selfie","preview-selfie");
});

</script>
</body>

</html>