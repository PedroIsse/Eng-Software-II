<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro Passageiro - Passo 2</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
</head>

<body>
    <main class="container">
        <section class="login-box">

            <div class="btn-voltar">
                <a href="telaCadastroPassageiro.html" class="ri-arrow-left-line"></a>
            </div>

            <div class="box-titulo">
                <h1 class="titulo">Informações de cadastro</h1>
            </div>

            <form class="upload-container form-login">
                <h2>Endereço</h2>

                <label>Rua *</label>
                <input type="text" id="rua" required>

                <label>Número *</label>
                <input type="text" id="numero" required>

                <label>Complemento</label>
                <input type="text" id="complemento" placeholder="Apto, Bloco (Opcional)">
            </form>

            <form class="upload-container form-login">
                <h2>Dados do cartão</h2>

                <label>Número do cartão *</label>
                <input type="text" id="cartao" placeholder="0000 0000 0000 0000" maxlength="19" required>

                <div style="display: flex; gap: 10px;">
                    <div style="flex: 1;">
                        <label>Validade *</label>
                        <input type="text" id="validade" placeholder="MM/AA" maxlength="5" required>
                    </div>
                    <div style="flex: 1;">
                        <label>CVV *</label>
                        <input type="text" id="cvv" placeholder="123" maxlength="4" required>
                    </div>
                </div>

                <label>Nome do titular *</label>
                <input type="text" id="titular" placeholder="Como no cartão" required>
            </form>

            <div class="btn-group">
                <a id="btnFinalizar" class="btns upload">Finalizar</a>
            </div>

            <div id="popup" class="popup">
                <div class="popup-content">
                    <h2>Gostaria de se cadastrar como motorista?</h2>

                    <div class="btn-group">
                        <a id="naoMotorista" class="btns upload">Não</a>
                        <a href="telaCadastroMotorista.html" class="btns upload">Sim</a>
                    </div>
                </div>
            </div>

            <div id="popupFinal" class="popup">
                <div class="popup-content">
                    <h2>Cadastro finalizado!</h2>
                    <h3>Você será redirecionado ao login.</h3>
                    <br>
                    <a href="index.html" class="btns upload">OK</a>
                </div>
            </div>

        </section>
    </main>

    <script>
        // Máscara Cartão de Crédito
        document.getElementById('cartao').addEventListener('input', function (e) {
            let value = e.target.value.replace(/\D/g, '');

            value = value.replace(/(\d{4})(?=\d)/g, '$1 ');
            e.target.value = value;
        });

        // Máscara Validade
        document.getElementById('validade').addEventListener('input', function (e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.replace(/^(\d{2})/, '$1/');
            }
            e.target.value = value;
        });

        // CVV
        document.getElementById('cvv').addEventListener('input', function (e) {
            e.target.value = e.target.value.replace(/\D/g, '');
        });

        // Lógica do Popup Final
        document.getElementById("naoMotorista").onclick = () => {
            document.getElementById("popup").style.display = "none";
            document.getElementById("popupFinal").style.display = "flex";
        };
    </script>

    <!-- LÓGICA DO FIREBASE E VALIDAÇÃO -->
    <script type="module">
        import { db, auth } from "./js/firebase.js";
        import { doc, updateDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        const btnFinalizar = document.getElementById("btnFinalizar");
        const popup = document.getElementById("popup");

        const elRua = document.getElementById("rua");
        const elNumero = document.getElementById("numero");
        const elComplemento = document.getElementById("complemento");
        const elCartao = document.getElementById("cartao");
        const elValidade = document.getElementById("validade");
        const elCvv = document.getElementById("cvv");
        const elTitular = document.getElementById("titular");

        async function finalizarCadastro() {
            const uid = auth.currentUser?.uid;

            if (!uid) {
                alert("Sessão expirada. Faça login novamente.");
                return;
            }

            if (!elRua.value.trim() || 
                !elNumero.value.trim() || 
                !elCartao.value.trim() || 
                !elValidade.value.trim() || 
                !elCvv.value.trim() || 
                !elTitular.value.trim()) {
                
                alert("Por favor, preencha todos os campos obrigatórios (marcados com *).");
                return;
            }

            if (elCartao.value.length < 16) {
                alert("Número de cartão inválido.");
                return;
            }

            try {
                btnFinalizar.innerText = "Salvando...";
                
                await updateDoc(doc(db, "passageiros", uid), {
                    endereco: {
                        rua: elRua.value,
                        numero: elNumero.value,
                        complemento: elComplemento.value
                    },
                    cartao: {
                        numero: elCartao.value,
                        validade: elValidade.value,
                        cvv: elCvv.value,
                        titular: elTitular.value
                    },
                    updatedAt: new Date().toISOString()
                });

                btnFinalizar.innerText = "Finalizar";
                popup.style.display = "flex";

            } catch (error) {
                console.error(error);
                btnFinalizar.innerText = "Finalizar";
                alert("Erro ao salvar dados: " + error.message);
            }
        }

        btnFinalizar.addEventListener("click", finalizarCadastro);
    </script>

</body>

</html>